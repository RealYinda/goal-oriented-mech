//
// 文件名:     PatchStrategy.h
// 软件包:     JAUMIN
// 版权　:     北京应用物理与计算数学研究所
// 版本号:     $Revision: 0 $
// 修改　:     $Date: Tue May 20 08:18:29 2014 $
// 描述　:     网格片策略类派生类.
//

#ifndef included_PatchStrategy
#define included_PatchStrategy

#include "StandardComponentPatchStrategy.h"
#include "DOFInfo.h"
#include "ElementManager.h"
#include "JaVisDataWriter.h"
using namespace JAUMIN;
class PatchStrategy : public algs::StandardComponentPatchStrategy<NDIM>,
                      tbox::Serializable {
public:
  /*! @brief 构造函数.
   * @param object_name          输入参数, 字符串, 表示对象名称.
   * @param input_db             输入参数，指针，指向输入数据库。
   * @param register_for_restart 输入参数, 逻辑型, 是否注册到重启动.
   */
  PatchStrategy(const string& object_name,
                tbox::Pointer<tbox::Database> input_db,
                bool register_for_restart);

  /*!
   * @brief 析构函数.
   */
  virtual ~PatchStrategy();

  /// @name 重载基类 algs::StandardComponentPatchStrategy<NDIM> 的函数:
  // @{

  /*!
   * @brief 初始化指定的积分构件.
   *
   * 注册待填充的数据片或待调度内存空间的数据片到积分构件.
   *
   * @param component 输入参数, 指针, 指向待初始化的积分构件对象.
   */
  void initializeComponent(algs::IntegratorComponent<NDIM>* component) const;

  /**
   * @brief 初始化数据片（支持有限元初值构件）.
   *
   * @param patch          输入参数, 网格片类, 表示网格片.
   * @param time           输入参数, 双精度浮点型, 表示初始化的时刻.
   * @param initial_time   输入参数, 逻辑型, 真值表示当前时刻为计算的初始时刻.
   * @param component_name 输入参数, 字符串, 当前调用该函数的初值构件之名称.
   */
  void initializePatchData(hier::Patch<NDIM>& patch, const double time,
                           const bool initial_time,
                           const string& component_name);

  /*!
   * @brief 支撑指定名称的数值构件, 在单个网格片上完成矩阵组装.
   *
   * @param patch          输入参数, 网格片类, 表示网格片.
   * @param time           输入参数, 双精度浮点型, 表示当前时刻.
   * @param dt             输入参数, 双精度浮点型, 表示时间步长.
   * @param component_name 输入参数, 字符串, 表示数值构件的名称.
   *
   */
  void buildMatrixOnPatch(hier::Patch<NDIM>& patch, const double time,
                          const double dt, const string& component_name);

  /*!
   * @brief 支撑指定名称的数值构件, 在单个网格片上完成右端项组装.
   *
   * @param patch          输入参数, 网格片类, 表示网格片.
   * @param time           输入参数, 双精度浮点型, 表示当前时刻.
   * @param dt             输入参数, 双精度浮点型, 表示时间步长.
   * @param component_name 输入参数, 字符串, 表示数值构件的名称.
   *
   */
  void buildRHSOnPatch(hier::Patch<NDIM>& patch, const double time,
                       const double dt, const string& component_name);

  /**
   * @brief 注册模型变量, 该函数调用EntisyStrategy的注册函数,
   *完成应户变量的注册.
   *
   */
  void registerModelVariable();

  /*!
   * @brief 在单个网格片上设置载荷.
   *
   * @param patch          输入参数, 网格片类, 表示网格片.
   * @param time           输入参数, 双精度浮点型, 表示当前时刻.
   * @param dt             输入参数, 双精度浮点型, 表示时间步长.
   * @param component_name 输入参数, 字符串, 表示数值构件的名称.
   *
   */
  void applyLoad(hier::Patch<NDIM>& patch, const double time, const double dt,
                 const string& component_name);

  /*!
   * @brief 在单个网格片上设置约束.
   *
   * @param patch          输入参数, 网格片类, 表示网格片.
   * @param time           输入参数, 双精度浮点型, 表示当前时刻.
   * @param dt             输入参数, 双精度浮点型, 表示时间步长.
   * @param component_name 输入参数, 字符串, 表示数值构件的名称.
   *
   */
  void applyConstraint(hier::Patch<NDIM>& patch, const double time,
                       const double dt, const string& component_name);

  /*!
   * @brief 在单个网格片上更新坐标.
   *
   * @param patch          输入参数, 网格片类, 表示网格片.
   * @param time           输入参数, 双精度浮点型, 表示当前时刻.
   * @param dt             输入参数, 双精度浮点型, 表示时间步长.
   * @param component_name 输入参数, 字符串, 表示数值构件的名称.
   *
   */
  void updateCoordinate(hier::Patch<NDIM>& patch, const double time,
                        const double dt, const string& component_name);

  /*!
   * @brief 在单个网格片上计算应力.
   *
   * @param patch          输入参数, 网格片类, 表示网格片.
   * @param time           输入参数, 双精度浮点型, 表示当前时刻.
   * @param dt             输入参数, 双精度浮点型, 表示时间步长.
   * @param component_name 输入参数, 字符串, 表示数值构件的名称.
   *
   */
  void computeStress(hier::Patch<NDIM>& patch, const double time,
                     const double dt, const string& component_name);

  /*!
   * @brief 支撑指定名称的有限元数值构件, 在单个网格片上完成数值计算.
   *
   * @param patch          输入参数, 网格片类, 表示网格片.
   * @param time           输入参数, 双精度浮点型, 表示当前时刻.
   * @param dt             输入参数, 双精度浮点型, 表示时间步长.
   * @param initial_time   输入参数, 逻辑型, 是否为初始时刻.
   * @param component_name 输入参数, 字符串, 表示数值构件的名称.
   *
   */
  void computeOnPatch(hier::Patch<NDIM>& patch, const double time,
                      const double dt, const bool initial_time,
                      const string& component_name);

  /*!
   * @brief 支撑指定名称的有限元步长构件, 在单个网格片上计算时间步长.
   *
   * @param patch          输入参数, 网格片类, 表示网格片.
   * @param time           输入参数, 双精度浮点型, 表示当前时刻.
   * @param initial_time   输入参数, 逻辑型, 真值表示当前时刻为计算的初始时刻.
   * @param flag_last_dt   输入参数, 整型, 表示前次返回的状态.
   * @param last_dt        输入参数, 双精度浮点型, 表示前次的时间步长.
   * @param component_name 输入参数, 字符串, 表示步长构件的名称.
   *
   * @return 双精度浮点型, 表示时间步长.
   */
  double getPatchDt(hier::Patch<NDIM>& patch, const double time,
                    const bool initial_time, const int flag_last_dt,
                    const double last_dt, const string& component_name);

  /*!
   * @brief 将数据成员输出到重启动数据库.
   * @param db 输入参数, 指针, 指向重启动数据库.
   */
  void putToDatabase(tbox::Pointer<tbox::Database> db);

  /**
   * @brief 从重启动数据库中读如参数。
   *
   * @param db 输入参数，指针，指向输入数据库。
   */
  void getFromRestart(tbox::Pointer<tbox::Database> db);

  /**
   * @brief 注册可视化数据.
   */
  void registerPlotData(
      tbox::Pointer<appu::JaVisDataWriter<NDIM> > javis_data_writer);

  /**
   * @brief 获取矩阵id
   *
   * @return 整型，矩阵id
   */
  int getMatrixID() { return d_matrix_id; }

  /**
   * @brief 获取向量id
   *
   * @return 整型，向量id
   */
  int getRHSID() { return d_rhs_id; }

  /**
   * @brief 获取解向量id
   *
   * @return 整型，解向量id
   */
  int getSolutionID() { return d_solution_id; }

  /**
   * @brief 获取自由度信息
   *
   * @return 指针，指向自由度信息
   */
  tbox::Pointer<solv::DOFInfo<NDIM> > getDOFInfo() { return d_dof_info; }

private:
  /*!@brief 从输入数据库读入数据.  */
  void getFromInput(tbox::Pointer<tbox::Database> db);

  bool d_registered_for_restart;

  /*!@brief 对象名.  */
  string d_object_name;
  tbox::Pointer<solv::DOFInfo<NDIM> > d_dof_info;

  tbox::Array<string> d_element_type; /**< 单元类型 */
  tbox::Array<int> d_element_marks;   /**< 单元的标示 */

  tbox::Array<string> d_constraint_types; /**< 约束类型数组 */
  tbox::Array<int> d_constraint_marks; /**< 约束作用的点集标识数组 */

  tbox::Array<string> d_load_types; /**< 载荷类型数组 */
  tbox::Array<int> d_load_marks;    /**< 载荷作用的点集标识数组 */

  /// 有限元计算相关的管理器(单元, 积分, 形函数, 材料, 约束, 载荷).
  tbox::Pointer<ElementManager<NDIM> > d_element_manager;

  /// 输入数据库指针.
  tbox::Pointer<tbox::Database> d_input_db;

  /// 变量的索引.
  int d_solution_id;
  int d_matrix_id;

  int d_rhs_id;
  int d_stress_id;
  int d_plot_id;
};
#endif
